<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>NewRational for .NET 6.0 </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="NewRational for .NET 6.0 ">
    <meta name="generator" content="docfx 2.59.1.0">
    
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" href="styles/docfx.vendor.css">
    <link rel="stylesheet" href="styles/docfx.css">
    <link rel="stylesheet" href="styles/main.css">
    <meta property="docfx:navrel" content="toc">
    <meta property="docfx:tocrel" content="toc">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="index.html">
                <img id="logo" class="svg" src="logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
                
                <ul class="nav level1 navbar-nav">
                      <li>
                          <a href="api/System.Numerics.Rational.html" title="Api Documentation">Api Documentation</a>
                      </li>
                </ul>    </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h2 id="newrational-for-net-60">NewRational for .NET 6.0</h2>

<h3 id="introduction">Introduction</h3>
<p>NewRational - a novel rational number class.</p>
<p>There are already many implementations of rational number classes called Rational, BigRational, Fraction etc.<br>
For C# the useful ones are based on a combination of System.Numerics.BigInteger for numerator and denominator,<br>
which in fact has the benefit of a really simple implementation.<br>
It works fine but in praxis it has several disadvantages:</p>
<ul>
<li>Performance is limited by System.Numerics.BigInteger which is not primarily designed for rational arithmetic.</li>
<li>Using BigInteger leads to a lot of unnecessary memory allocations for all the intermediate results at runtime, which means, extra work for the GC.</li>
<li>Based on BigInteger the struct size of a Rational is unnecessary big, therefore also inefficient to use in Vector or Matrix classes.</li>
<li>The system requires a lot of internal memory copies, bad for the overall performance.</li>
<li>There is no way to benefit from the performance improvements in .NET Core, like using Spans, Buffers and Intrinsics.</li>
</ul>
<p>NewRational is based on a completely new system to achieve better efficiency and performance.<br>
The interface itself is of course the same as for all other numeric types, supporting the
basic arithmetic operations via operators, conversions from and to the numeric system types,
string formatting and parsing, binary serialization, etc.<br>
As an immutable, readonly struct with only one array field, the layout is as small as possible and similar to a System.String.<br>
Internal the class has its own big-integer calculation core, highly optimized for the purposes of rational arithmetics, encapsulated in a stack machine.<br>
This stack machine is public and offers a second interface layer with a machine language like instruction set.<br>
Using this interface allows optimization on function level with performance improvements by factor 4 to 10.</p>
<p><em>Example: Classic cross product for a Vector3 type, this one with:</em> <code>NewRational X, Y, Z;</code></p>
<pre><code>public static Vector3R Cross(Vector3R a, Vector3R b)
{ 
  var x = a.Y * b.Z - a.Z * b.Y; 
  var y = a.Z * b.X - a.X * b.Z;
  var z = a.X * b.Y - a.Y * b.X;
  return new Vector3R(x, y, z);
}
</code></pre>
<p><em>The same function can be optimized using the stack machine (cpu):</em></p>
<pre><code>public static Vector3R Cross(Vector3R a, Vector3R b)
{
  var cpu = NewRational.task_cpu;
  cpu.mul(a.X, b.Y); cpu.mul(a.Y, b.X); cpu.sub();
  cpu.mul(a.Z, b.X); cpu.mul(a.X, b.Z); cpu.sub();
  cpu.mul(a.Y, b.Z); cpu.mul(a.Z, b.Y); cpu.sub();
  return new Vector3R(cpu.pop_rat(), cpu.pop_rat(), cpu.pop_rat());
}
</code></pre>
<p><em>The optimized version performs 4 x faster, only 3 final normalizations and memory allocs are necessary (instead of 9 for the first version).</em></p>
<p>As the example shows, using the stack machine directly is not much more difficult or less readable.<br>
Furthermore, this design separates the NewRational struct from the calculation core, the final number object is always normalized what makes the handling, comparsions etc. much easier and doesn't impact the performance of the calculations.</p>
<h3 id="data-layout">Data Layout</h3>
<p>All data, numerator and denominator, is stored in a single variable-length uint array.<br>
This gives the NewRational struct itself a machine word size and can therefore internal passed around as fast as possible.</p>
<pre><code>public readonly struct NewRational
{
  private readonly uint[] p; // the one and only field
</code></pre>
<p>The array starts with a uint header containing a sign-bit and the number of following uint digits for the numerator.<br>
Diectly followed by the same structure for the denominator. The order is little-endian.<br>
A null array, as default value of the struct, represents the number 0 (zero).</p>
<p><img src="images/rat_p_struct.png" alt="Rat P Struct"></p>
<p>This simple structure has several advantages:</p>
<ul>
<li>Exchange, transfer, serialization and marshalling is easy, for example via COM.</li>
<li>The calculation core can directly access the integer parts without conversions.</li>
<li>As Span it is very efficient to build vectors or multidimensional matrices.</li>
<li>The content is easy to debug.</li>
</ul>
<p>The disadvantage is that small numbers that would fit in a machine word, also requires an array.<br>
This is the price for a optimal throughput and less code as there are no special cases to handle.</p>
<h2 id="stack-machine">Stack machine</h2>
<p>The stack machine, named CPU, is implemented as nested class in NewRational to get access to the private member.<br>
The class has only two private fields, an array of arrays of uint (uint[][] p) and a index (int i) that marks the current stack top.</p>
<pre><code>public struct NewRational 
{  
  public class CPU
  {
    uint[][] p; int i;
</code></pre>
<p>A push operation increases the index and can use the buffer at p[i], which is mostly already of the required size.<br>
A pop operation does nothing else than decrement the index.<br>
Each uint[] buffer in the stack represents a rational number with the same data layout as in struct NewRational.</p>
<p>Internally the stack is used excessively for all basic arithmetic operations
and so no further memory management is necessary.<br>
However, in consequence, for every single calculation step with NewRational numbers it needs a instance of
such stack-machine object what is only efficient when it is as shared object always available.
For this there is one thread-local static instance named <code>task_cpu</code>, exposed as static property in NewRational.</p>
<pre><code>public static CPU task_cpu
{
  get { return _cpu ??= new CPU(); }
}
[ThreadStatic] private static CPU? _cpu;
</code></pre>
<p>Thread static means that each thread has its own instance of a task_cpu when needed, ensuring thread safety.</p>
<p>This simple system has the advantage that it is also easy to debug:</p>
<img src="images/debug_pi2.png" width="400">
<p>The system implies that the stack machine exposes an <a href="api/System.Numerics.Rational.NewRational.CPU.html">instruction set</a>.<br>
These instructions, for readability as short words, are self explaining basic commands like add(), sub(), mul(), div(), different push() and pop(),  bit level operations like shl(), shr(), but also higher level commands like pow(), mod(), rnd() etc.</p>
<p>Since the rational numbers can have arbitrary size, it is important for the performance to avoid unnecessary memory copies.<br>
This explains several versions of same instructions, for example:</p>
<pre><code>  cpu.push(x); // implies a memory copy
  cpu.push(y); // implies a memory copy
  cpu.add();  
  // For performance it is better to write:
  cpu.add(x, y); // no copies necessary, same result
</code></pre>
<p>In general there is a difference to other stack machines, where the entries can be quickly copied, duplicated etc. since they are mostly in machine word size.<br>
Here we have buffers of arbitrary size as stack entries and for performance it is all about to avoid unnecessary memory copies.<br>
To do this there are swap instructions, <code>cpu.swp()</code>, which internally exchange buffer pointers and this operation is fast since a pointer has machine word size.</p>
<h2 id="performance-comparsions">Performance comparsions</h2>
<p>A test app is currently under development that will generate detailed benchmark reports comparing usual implementations with the new system.<br>
In general, the performance increases by at least a factor of 2, by using the stack machine up to a factor of 10 and more.<br>
This applies to geometric algorithms where precision is important and not so much calculating with gigantic numbers.<br>
For really huge numbers, with kBytes of digit data, the bottleneck is the integer multiplication as O(n^2) operation (with simple algorithm).<br>
Then, the performance of both systems equalizes again.</p>
<p>Using NewRational for pure integer arithmetic is not faster than using BigInteger.<br>
But by using the stack machine in functions, iterations etc., the performance can be increased.</p>
<hr>
<p><img src="images/underconst.png" alt="T1"></p>
<!-- 

### [API Documentation](api/System.Numerics.Rational.NewRational.yml)
 
![\Large x=\frac{-b\pm\sqrt{b^2-4ac}}{2a}](https://latex.codecogs.com/svg.latex?x%3D%5Cfrac%7B-b%5Cpm%5Csqrt%7Bb%5E2-4ac%7D%7D%7B2a%7D)

![](https://latex.codecogs.com/svg.image?\frac{1}{3}&space;\sqrt{2})

[!include[](../RationalNumerics/readme.md)] 
 
-->
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="styles/docfx.js"></script>
    <script type="text/javascript" src="styles/main.js"></script>
  </body>
</html>
